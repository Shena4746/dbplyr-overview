<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>dbplyr 概論</title>
  <meta name="description" content="An overview on dbplyr pakcages" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="dbplyr 概論" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="An overview on dbplyr pakcages" />
  <meta name="github-repo" content="Shena4746/dbplyr-overview" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="dbplyr 概論" />
  
  <meta name="twitter:description" content="An overview on dbplyr pakcages" />
  

<meta name="author" content="Shena" />


<meta name="date" content="2022-07-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #232629;
    color: #7a7c7d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
div.sourceCode
  { color: #cfcfc2; background-color: #232629; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #cfcfc2; } /* Normal */
code span.al { color: #95da4c; } /* Alert */
code span.an { color: #3f8058; } /* Annotation */
code span.at { color: #2980b9; } /* Attribute */
code span.bn { color: #f67400; } /* BaseN */
code span.bu { color: #7f8c8d; } /* BuiltIn */
code span.cf { color: #fdbc4b; } /* ControlFlow */
code span.ch { color: #3daee9; } /* Char */
code span.cn { color: #27aeae; } /* Constant */
code span.co { color: #7a7c7d; } /* Comment */
code span.cv { color: #7f8c8d; } /* CommentVar */
code span.do { color: #a43340; } /* Documentation */
code span.dt { color: #2980b9; } /* DataType */
code span.dv { color: #f67400; } /* DecVal */
code span.er { color: #da4453; } /* Error */
code span.ex { color: #0099ff; } /* Extension */
code span.fl { color: #f67400; } /* Float */
code span.fu { color: #8e44ad; } /* Function */
code span.im { color: #27ae60; } /* Import */
code span.in { color: #c45b00; } /* Information */
code span.kw { color: #cfcfc2; } /* Keyword */
code span.op { color: #cfcfc2; } /* Operator */
code span.ot { color: #27ae60; } /* Other */
code span.pp { color: #27ae60; } /* Preprocessor */
code span.re { color: #2980b9; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #da4453; } /* SpecialString */
code span.st { color: #f44f4f; } /* String */
code span.va { color: #27aeae; } /* Variable */
code span.vs { color: #da4453; } /* VerbatimString */
code span.wa { color: #da4453; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path=""><a href="#about-dbplyr"><i class="fa fa-check"></i><b>1</b> dbplyr とは</a><ul>
<li class="chapter" data-level="1.1" data-path=""><a href="#about"><i class="fa fa-check"></i><b>1.1</b> 概要</a></li>
<li class="chapter" data-level="1.2" data-path=""><a href="#pros-cons"><i class="fa fa-check"></i><b>1.2</b> Pros &amp; Cons</a></li>
<li class="chapter" data-level="1.3" data-path=""><a href="#work-flow"><i class="fa fa-check"></i><b>1.3</b> 標準的な作業フロー</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path=""><a href="#sample-code"><i class="fa fa-check"></i><b>2</b> サンプルコード</a><ul>
<li class="chapter" data-level="2.1" data-path=""><a href="#r-から-db-への接続"><i class="fa fa-check"></i><b>2.1</b> R から DB への接続</a></li>
<li class="chapter" data-level="2.2" data-path=""><a href="#テーブルへの参照とクエリの実行"><i class="fa fa-check"></i><b>2.2</b> テーブルへの参照とクエリの実行</a></li>
<li class="chapter" data-level="2.3" data-path=""><a href="#sql-文の取得"><i class="fa fa-check"></i><b>2.3</b> SQL 文の取得</a></li>
<li class="chapter" data-level="2.4" data-path=""><a href="#翻訳できない-r-関数例"><i class="fa fa-check"></i><b>2.4</b> 翻訳できない R 関数例</a></li>
<li class="chapter" data-level="2.5" data-path=""><a href="#データのダウンロード"><i class="fa fa-check"></i><b>2.5</b> データのダウンロード</a></li>
<li class="chapter" data-level="2.6" data-path=""><a href="#upload"><i class="fa fa-check"></i><b>2.6</b> データのアップロード</a><ul>
<li class="chapter" data-level="2.6.1" data-path=""><a href="#ローカルデータ---db-テーブル"><i class="fa fa-check"></i><b>2.6.1</b> ローカルデータ -&gt; DB テーブル</a></li>
<li class="chapter" data-level="2.6.2" data-path=""><a href="#ローカルデータ---tbl_lazy"><i class="fa fa-check"></i><b>2.6.2</b> ローカルデータ -&gt; tbl_lazy</a></li>
<li class="chapter" data-level="2.6.3" data-path=""><a href="#tbl_lazy---db-テーブル"><i class="fa fa-check"></i><b>2.6.3</b> tbl_lazy -&gt; DB テーブル</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path=""><a href="#ref"><i class="fa fa-check"></i><b>3</b> References: dbplyr, DBI, RPostgres 参考資料</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbplyr 概論</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">dbplyr 概論</h1>
<p class="author"><em>Shena</em></p>
<p class="date"><em>2022-07-16</em></p>
</div>


<div id="about-dbplyr" class="section level1 hasAnchor">
<h1><span class="header-section-number">1</span> dbplyr とは<a href="#about-dbplyr" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="https://dbplyr.tidyverse.org/index.html">dbplyr 公式</a>.</p>
<div id="about" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.1</span> 概要<a href="#about" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>dbplyr とは, dplyr が DB からデータを得て加工処理を行う際にバックエンドとして働くパッケージ. dbplyr が影で働いてくれるおかげで, DB 上のデータを手元にダウンロードしていないにも関わらず, あたかも手元にあるかのように, 手慣れた dplyr の文法でデータ加工処理を行うことができる.</p>
<p>dbplyr は, dplyr の文法で書いたデータ加工処理を接続先の DBMS に合わせた適切な SQL クエリに翻訳する.
翻訳されたクエリは DB との通信を担当する DBI (Database Interface) パッケージを通して実行され, その実行結果は参照としてローカルに返される.
これは, SQL の実行結果が常に実データとして手元にダウンロードされる DBI とは対照的である.</p>
<p>たとえば, <a href="https://shena4746.github.io/datascience-100knocks-preprocess-R/#r-042">R042 - dbplyrでデータサイエンス100本ノック</a> は見た目は普通の R コードだが, SQL に翻訳されてサーバー側で実行され, その結果は参照として返されている. そのため, テーブルの表示が通常の tibble などと少しだけ異なるが, dplyr と大きく異なる印象は受けないだろう. 実際, <strong>翻訳が上手く働く限り</strong>, dbplyr を意識する必要はほとんどなく, dplyr だと思って書くことができる.</p>
</div>
<div id="pros-cons" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.2</span> Pros &amp; Cons<a href="#pros-cons" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>直接 SQL を書くのではなく dbplyr を使う長所と短所を整理しておく.</p>
<ul>
<li>長所
<ul>
<li>R - SQL 間の, いわゆる言語またぎが減る</li>
<li>SQL の方言に関わらず, dplyr による統一的な書き方ができる</li>
<li>多くの場合, コードがより簡潔になる</li>
</ul></li>
<li>短所
<ul>
<li>SQL に比べて(ユーザーと?)文献が少ない</li>
<li>新たに利用するパッケージについて学習コストが発生する
<ul>
<li>dbplyr, DBI などのパッケージ自体の学習</li>
<li>dbplyr が翻訳可能な R コードの分類</li>
</ul></li>
</ul></li>
</ul>
<p>特に, 翻訳不可能なコードが存在することは強調しておきたい. たとえば, <code>base::quantile</code> は非常に限定的なケースでしか翻訳できないし, <code>dplyr::group_modify</code> は全く翻訳不可能である.</p>
</div>
<div id="work-flow" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.3</span> 標準的な作業フロー<a href="#work-flow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>以下は, dbplyr を利用する際の典型的な作業フローの概要. 教科書的には, 次のようになる.</p>
<ul>
<li><strong>接続</strong>: DBI と 接続先 DBMS に対応した専用パッケージ (e.g., RPostgres, RSQLite) で接続を確立.</li>
<li><strong>テーブルへの参照取得</strong>: 接続した DB 上のテーブルへの参照を取得.</li>
<li><strong>処理内容の作成</strong>: 参照先のテーブルに対して, dplyr の文法でデータ加工処理を書く.</li>
<li><strong>SQLへの翻訳 (自動実行)</strong>: dbplyr がその処理内容を SQL に変換する.</li>
<li><strong>SQL の実行 (自動実行)</strong>: DBI 等のバックエンドパッケージがその SQL を実行し, 結果への参照を返す.</li>
<li><strong>処理済テーブルの作成 (任意)</strong>: 加工を終えたデータを新たなテーブルとして DB に書き込む.</li>
</ul>
<p>しかし, 現実には <a href="#pros-cons">Pros &amp; Cons</a> で言及した翻訳問題に直面することが多々ある. その際は, サイズが十分小さくなるまで加工したデータをローカルマシンにダウンロードし, 通常の R での加工処理に帰着させる方法をよく取る. この場合, 先述の作業フローに次が追加される.</p>
<ul>
<li><strong>データのダウンロード</strong>: DB 上のデータを dplyr で手元にダウンロードする.</li>
<li><strong>ローカルでのデータ加工</strong>: ダウンロードデータを通常のローカルデータとしてさらに加工する. パッケージ含め任意のR関数が自由に使える.</li>
<li><strong>データのアップロード (任意)</strong>: ローカルでの加工を終えたデータを DB 上にアップロードする.</li>
</ul>
<p>もちろん, これは R 上で作業を続けるという場合のフローである. そうではなく, SQL で書くことに切り替えるという選択肢も当然存在する. なお, 本稿では詳しく触れないが, DBI には R 上から SQL を発行して実行するメソッドも存在する. 必要に応じて <a href="ref">参考文献</a> や公式ドキュメントを参照されたい.</p>

</div>
</div>
<div id="sample-code" class="section level1 hasAnchor">
<h1><span class="header-section-number">2</span> サンプルコード<a href="#sample-code" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="work-flow">標準的な作業フロー</a> に沿って, そのコード例を示す.</p>
<p>データは, <a href="https://github.com/The-Japan-DataScientist-Society/100knocks-preprocess">データサイエンス100本ノック（構造化データ加工編）</a> のものを使い, Postgres DB がどこかに立ててあると仮定する.</p>
<p>途中で DBI のメソッドがたまに出てくるが, それについてはここでは深入りしない. 必要に応じて参考文献にある DBI の関連情報にあたって欲しい.</p>
<div id="r-から-db-への接続" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.1</span> R から DB への接続<a href="#r-から-db-への接続" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a> 記載の方法に従う.</p>
<p>必須パッケージ達.
最初の2つは DB への接続用.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">R.version.string <span class="co"># R version</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="co">## [1] &quot;R version 4.2.0 (2022-04-22)&quot;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">packageVersion</span>(<span class="st">&quot;RPostgres&quot;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">## [1] &#39;1.4.4.9000&#39;</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">packageVersion</span>(<span class="st">&quot;DBI&quot;</span>)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co">## [1] &#39;1.1.3&#39;</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">packageVersion</span>(<span class="st">&quot;dbplyr&quot;</span>) <span class="co"># automatically loaded</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co">## [1] &#39;2.2.1&#39;</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">packageVersion</span>(<span class="st">&quot;dplyr&quot;</span>)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">## [1] &#39;1.0.9&#39;</span></a></code></pre></div>
<p>まだしてなければ, bash を叩いて Postgres を起動.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">sudo</span> service postgresql start</a></code></pre></div>
<p><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a> は, DB 接続のためのコードとして以下の例と注意を述べている:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb3-2" title="2">    <span class="dt">drv =</span> RPostgreSQL<span class="op">::</span><span class="kw">PostgreSQL</span>(),</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="dt">host =</span> <span class="st">&quot;database.rstudio.com&quot;</span>,</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="dt">user =</span> <span class="st">&quot;your-name&quot;</span>,</a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="dt">password =</span> rstudioapi<span class="op">::</span><span class="kw">askForPassword</span>(<span class="st">&quot;Database password&quot;</span>)</a>
<a class="sourceLine" id="cb3-6" title="6">)</a></code></pre></div>
<blockquote>
<p>If you’re not using RStudio, you’ll need some other way to securely retrieve your password. You should never record it in your analysis scripts or type it into the console. <a href="https://db.rstudio.com/best-practices/managing-credentials">Securing Credentials</a> provides some best practices.</p>
</blockquote>
<p>これを踏まえると, 以下の接続方法は大変行儀が悪いが, 今回はどうせ localhost にこのノック限定で立てている DB だろうから, ここでは咎めないことにする.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb4-2" title="2">    <span class="dt">drv =</span> RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="dt">dbname =</span> <span class="st">&quot;your-database-name&quot;</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="dt">user =</span> <span class="st">&quot;your-user&quot;</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="dt">password =</span> <span class="st">&quot;your-password&quot;</span></a>
<a class="sourceLine" id="cb4-8" title="8">)</a></code></pre></div>
<p>ここで, <code>DBI::dbConnect()</code> は <code>DBIConnection</code> クラスのインスタンスを返す関数である. <code>DBIConnection</code> は DB へのログイン情報を記述するクラスだと思えばよい. 接続先の DB に用がある間はこのインスタンスを少なくとも1つは変数に格納して持っておく必要がある. この変数は, 一般に, <code>DBI::dbDisconnect()</code> によって明示的に接続を解除しない限り, 有効であり続ける. 個別の事情がない限り, <code>DBIConnection</code> を2つ以上持つ実益はない. むしろ, 杜撰に管理された場合にリソースを無駄使いする可能性が生じやすい. したがって, <code>DBI::dbConnect()</code> は必要最小回数だけ, つまり, 接続開始時に1回だけ使うことが基本となる.</p>
<p>接続できたか確認する意味も兼ねて, DB 上のテーブル一覧を次のようにして取得しよう.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">## [1] &quot;customer&quot; &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a></code></pre></div>
<p>また, DB への用が済んだら接続解除することも必須である. 一般に, DBMS と DBI は解除されていない <code>DBIConnection</code> に関わるリソースを保持し続ける. このリソースには, クエリの実行結果や一時テーブルが含まれるため, 時にメモリを圧迫する原因となる. 接続解除は次のようにすればよい.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbDisconnect</span>()</a></code></pre></div>
</div>
<div id="テーブルへの参照とクエリの実行" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.2</span> テーブルへの参照とクエリの実行<a href="#テーブルへの参照とクエリの実行" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><code>DBIConnection</code> クラスは DBI 関数を使う際に必ずと言ってよいほど頻繁に使うが, 実は dbplyr を使う際はそうでもない. DB 上のテーブルの参照を取得するときと, データを DB 側に渡すとき (<a href="#upload">2.6</a> 参照) くらいである.</p>
<p>DB 上のテーブルへの参照は, 以下のようにして取得する.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">receipt_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;receipt&quot;</span>)</a>
<a class="sourceLine" id="cb7-2" title="2">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">## [1] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;          &quot;tbl_lazy&quot;        </span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">## [5] &quot;tbl&quot;</span></a></code></pre></div>
<p>このオブジェクトは, 実データとしての <code>tibble</code> ではなく, <code>tbl_dbi</code> オブジェクトである. dbplyr の文脈では <code>tbl_lazy</code> と呼ばれることも多いようだ.</p>
<p>この<code>tbl_lazy</code>は実データではないが, 実データであるかのように加工処理の対象として扱える. この加工処理の裏では, R による処理が SQL へと翻訳され実行され…というプロセスが走っている.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># not a data</span></a>
<a class="sourceLine" id="cb8-2" title="2">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>()</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">## List of 2</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">##  $ src       :List of 2</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">##   ..$ con  :Formal class &#39;PqConnection&#39; [package &quot;RPostgres&quot;] with 5 slots</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">##   .. .. ..@ ptr         :&lt;externalptr&gt; </span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">##   .. .. ..@ bigint      : chr &quot;integer64&quot;</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">##   .. .. ..@ timezone    : chr &quot;UTC&quot;</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">##   .. .. ..@ timezone_out: chr &quot;UTC&quot;</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">##   .. .. ..@ typnames    :&#39;data.frame&#39;:   424 obs. of  2 variables:</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">##   .. .. .. ..$ oid    : int [1:424] 16 17 18 19 20 21 22 23 24 25 ...</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">##   .. .. .. ..$ typname: chr [1:424] &quot;bool&quot; &quot;bytea&quot; &quot;char&quot; &quot;name&quot; ...</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">##   ..$ disco: NULL</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">##   ..- attr(*, &quot;class&quot;)= chr [1:4] &quot;src_PqConnection&quot; &quot;src_dbi&quot; &quot;src_sql&quot; &quot;src&quot;</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">##  $ lazy_query:List of 5</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">##   ..$ x         : &#39;ident&#39; chr &quot;receipt&quot;</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co">##   ..$ vars      : chr [1:9] &quot;sales_ymd&quot; &quot;sales_epoch&quot; &quot;store_cd&quot; &quot;receipt_no&quot; ...</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co">##   ..$ group_vars: chr(0) </span></a>
<a class="sourceLine" id="cb8-19" title="19"><span class="co">##   ..$ order_vars: NULL</span></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co">##   ..$ frame     : NULL</span></a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co">##   ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;lazy_base_remote_query&quot; &quot;lazy_base_query&quot; &quot;lazy_query&quot;</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co">##  - attr(*, &quot;class&quot;)= chr [1:5] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot; &quot;tbl_sql&quot; &quot;tbl_lazy&quot; ...</span></a>
<a class="sourceLine" id="cb8-23" title="23"></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co"># but behave like data</span></a>
<a class="sourceLine" id="cb8-25" title="25">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">colnames</span>()</a>
<a class="sourceLine" id="cb8-26" title="26"><span class="co">## [1] &quot;sales_ymd&quot;      &quot;sales_epoch&quot;    &quot;store_cd&quot;       &quot;receipt_no&quot;    </span></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="co">## [5] &quot;receipt_sub_no&quot; &quot;customer_id&quot;    &quot;product_cd&quot;     &quot;quantity&quot;      </span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="co">## [9] &quot;amount&quot;</span></a>
<a class="sourceLine" id="cb8-29" title="29">receipt_<span class="dv">1000</span> &lt;-<span class="st"> </span>receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-30" title="30"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb8-31" title="31">receipt_<span class="dv">1000</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</a>
<a class="sourceLine" id="cb8-32" title="32"><span class="co">## [1] &quot;tbl_PqConnection&quot; &quot;tbl_dbi&quot;          &quot;tbl_sql&quot;          &quot;tbl_lazy&quot;        </span></a>
<a class="sourceLine" id="cb8-33" title="33"><span class="co">## [5] &quot;tbl&quot;</span></a>
<a class="sourceLine" id="cb8-34" title="34">receipt_<span class="dv">1000</span></a>
<a class="sourceLine" id="cb8-35" title="35"><span class="co">## # Source:   SQL [?? x 9]</span></a>
<a class="sourceLine" id="cb8-36" title="36"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb8-37" title="37"><span class="co">##    sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   </span></a>
<a class="sourceLine" id="cb8-38" title="38"><span class="co">##        &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         </span></a>
<a class="sourceLine" id="cb8-39" title="39"><span class="co">##  1  20181225  1545696000 S13020         1172              2 ZZ000000000000</span></a>
<a class="sourceLine" id="cb8-40" title="40"><span class="co">##  2  20180911  1536624000 S13018         1122              2 CS018205000001</span></a>
<a class="sourceLine" id="cb8-41" title="41"><span class="co">##  3  20170501  1493596800 S13004         1192              2 CS004415000232</span></a>
<a class="sourceLine" id="cb8-42" title="42"><span class="co">##  4  20170523  1495497600 S14028         1182              2 CS028415000203</span></a>
<a class="sourceLine" id="cb8-43" title="43"><span class="co">##  5  20180310  1520640000 S14028          112              1 ZZ000000000000</span></a>
<a class="sourceLine" id="cb8-44" title="44"><span class="co">##  6  20170516  1494892800 S14023         1102              1 CS023415000240</span></a>
<a class="sourceLine" id="cb8-45" title="45"><span class="co">##  7  20190615  1560556800 S13039         1102              2 CS039415000129</span></a>
<a class="sourceLine" id="cb8-46" title="46"><span class="co">##  8  20180610  1528588800 S13001         1162              2 CS001415000472</span></a>
<a class="sourceLine" id="cb8-47" title="47"><span class="co">##  9  20170906  1504656000 S13032         1122              2 ZZ000000000000</span></a>
<a class="sourceLine" id="cb8-48" title="48"><span class="co">## 10  20180819  1534636800 S13019          112              2 CS019215000046</span></a>
<a class="sourceLine" id="cb8-49" title="49"><span class="co">## # … with more rows, and 3 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb8-50" title="50"><span class="co">## #   amount &lt;int&gt;</span></a></code></pre></div>
<p>このとき返されるのは, 入力元と同じ <code>tbl_lazy</code> である.
なお, この例のように, <code>tbl_lazy</code> は <code>head()</code> を使わなくても自動的に数行の情報を返す.</p>
</div>
<div id="sql-文の取得" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.3</span> SQL 文の取得<a href="#sql-文の取得" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>R から SQL への翻訳パートにも触れておこう. 先述のように, この翻訳過程は自動的に実行されるため初心者が意識する必要はあまりない. よって, ここは気になるまで無視しても構わない.</p>
<p>R 上の加工処理がどのような SQL クエリに翻訳されたかは <code>dbplyr::show_query()</code> によって調べることができる.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">amount_mean =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mean</span>(<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span>amount_mean) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">## &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">## SELECT *</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">## FROM (</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">##   SELECT *, AVG(&quot;amount&quot;) OVER () AS &quot;amount_mean&quot;</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">##   FROM &quot;receipt&quot;</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">## ) &quot;q01&quot;</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">## WHERE (&quot;amount&quot; &gt;= &quot;amount_mean&quot;)</span></a>
<a class="sourceLine" id="cb9-12" title="12"></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co"># total amount of purchase per customer_id</span></a>
<a class="sourceLine" id="cb9-14" title="14">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>(<span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">## &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">## SELECT &quot;customer_id&quot;, SUM(&quot;amount&quot;) AS &quot;amount&quot;</span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">## FROM &quot;receipt&quot;</span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">## GROUP BY &quot;customer_id&quot;</span></a>
<a class="sourceLine" id="cb9-22" title="22"></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co"># number of NA on each column</span></a>
<a class="sourceLine" id="cb9-24" title="24">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-25" title="25"><span class="st">    </span><span class="kw">tbl</span>(<span class="st">&quot;product&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-26" title="26"><span class="st">    </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb9-27" title="27">        <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb9-28" title="28">            <span class="dt">.cols =</span> <span class="kw">everything</span>(),</a>
<a class="sourceLine" id="cb9-29" title="29">            <span class="dt">.fns =</span> <span class="op">~</span><span class="st"> </span><span class="kw">if_else</span>(<span class="kw">is.na</span>(.x), <span class="dv">1</span>, <span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>(),</a>
<a class="sourceLine" id="cb9-30" title="30">            <span class="dt">.names =</span> <span class="st">&quot;{.col}_NA&quot;</span></a>
<a class="sourceLine" id="cb9-31" title="31">        )</a>
<a class="sourceLine" id="cb9-32" title="32">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-33" title="33"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb9-34" title="34"><span class="co">## &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb9-35" title="35"><span class="co">## SELECT</span></a>
<a class="sourceLine" id="cb9-36" title="36"><span class="co">##   SUM(CASE WHEN ((&quot;product_cd&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;product_cd&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;product_cd_NA&quot;,</span></a>
<a class="sourceLine" id="cb9-37" title="37"><span class="co">##   SUM(CASE WHEN ((&quot;category_major_cd&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;category_major_cd&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;category_major_cd_NA&quot;,</span></a>
<a class="sourceLine" id="cb9-38" title="38"><span class="co">##   SUM(CASE WHEN ((&quot;category_medium_cd&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;category_medium_cd&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;category_medium_cd_NA&quot;,</span></a>
<a class="sourceLine" id="cb9-39" title="39"><span class="co">##   SUM(CASE WHEN ((&quot;category_small_cd&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;category_small_cd&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;category_small_cd_NA&quot;,</span></a>
<a class="sourceLine" id="cb9-40" title="40"><span class="co">##   SUM(CASE WHEN ((&quot;unit_price&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;unit_price&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;unit_price_NA&quot;,</span></a>
<a class="sourceLine" id="cb9-41" title="41"><span class="co">##   SUM(CASE WHEN ((&quot;unit_cost&quot; IS NULL)) THEN 1.0 WHEN NOT ((&quot;unit_cost&quot; IS NULL)) THEN 0.0 </span><span class="re">END</span><span class="co">) AS &quot;unit_cost_NA&quot;</span></a>
<a class="sourceLine" id="cb9-42" title="42"><span class="co">## FROM &quot;product&quot;</span></a></code></pre></div>
<p>この翻訳結果を文字列として得るには <code>show_query()</code> ではなく, <code>dbplyr::sql_render()</code> を使う.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># show_query() does not work as intended</span></a>
<a class="sourceLine" id="cb10-2" title="2">str_query &lt;-<span class="st"> </span>receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co">## &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">## SELECT *</span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">## FROM &quot;receipt&quot;</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">## WHERE (&quot;amount&quot; &gt;= 1000.0)</span></a>
<a class="sourceLine" id="cb10-9" title="9">str_query <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>()</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">## # Source:   SQL [?? x 9]</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">##    sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   </span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">##        &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         </span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">##  1  20181225  1545696000 S13020         1172              2 ZZ000000000000</span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">##  2  20180911  1536624000 S13018         1122              2 CS018205000001</span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">##  3  20170501  1493596800 S13004         1192              2 CS004415000232</span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">##  4  20170523  1495497600 S14028         1182              2 CS028415000203</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">##  5  20180310  1520640000 S14028          112              1 ZZ000000000000</span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">##  6  20170516  1494892800 S14023         1102              1 CS023415000240</span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">##  7  20190615  1560556800 S13039         1102              2 CS039415000129</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co">##  8  20180610  1528588800 S13001         1162              2 CS001415000472</span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">##  9  20170906  1504656000 S13032         1122              2 ZZ000000000000</span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="co">## 10  20180819  1534636800 S13019          112              2 CS019215000046</span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="co">## # … with more rows, and 3 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="co">## #   amount &lt;int&gt;</span></a>
<a class="sourceLine" id="cb10-26" title="26"></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co"># sql_render() works</span></a>
<a class="sourceLine" id="cb10-28" title="28">str_query &lt;-<span class="st"> </span>receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-29" title="29"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-30" title="30"><span class="st">    </span>dbplyr<span class="op">::</span><span class="kw">sql_render</span>()</a>
<a class="sourceLine" id="cb10-31" title="31">str_query <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>()</a>
<a class="sourceLine" id="cb10-32" title="32"><span class="co">## &lt;SQL&gt; SELECT *</span></a>
<a class="sourceLine" id="cb10-33" title="33"><span class="co">## FROM &quot;receipt&quot;</span></a>
<a class="sourceLine" id="cb10-34" title="34"><span class="co">## WHERE (&quot;amount&quot; &gt;= 1000.0)</span></a></code></pre></div>
<p>こうして翻訳された SQL クエリは DBI パッケージを通して実行される. DBI パッケージについては <a href="ref">References</a> の文献を参照.</p>
<p>なお, 後述する <code>collect()</code> を挟んだデータをこれらのメソッドに与えるとエラーになる.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="st">    </span><span class="kw">summarise</span>(<span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="st">    </span><span class="kw">show_query</span>() <span class="co"># error. can&#39;t trace back to a remote table</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">## Error in UseMethod(&quot;show_query&quot;): no applicable method for &#39;show_query&#39; applied to an object of class &quot;c(&#39;tbl_df&#39;, &#39;tbl&#39;, &#39;data.frame&#39;)&quot;</span></a></code></pre></div>
<p>DB 上のテーブルとの関連を失ったデータを得る方法を SQL で表すことはできないという自然な挙動だ.</p>
</div>
<div id="翻訳できない-r-関数例" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.4</span> 翻訳できない R 関数例<a href="#翻訳できない-r-関数例" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>実データではないので, <code>tbl_dbi %&gt;% nrow()</code> は常に <code>NA</code> になる.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nrow</span>()</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">## [1] NA</span></a></code></pre></div>
<p>これは代わりに, <code>count()</code> あるいは <code>summarise()</code> で数えてもらえばよい. これらは dbplyr を通しても使える.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>()</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co">## # Source:   SQL [1 x 1]</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">##         n</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co">##   &lt;int64&gt;</span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co">## 1  104681</span></a>
<a class="sourceLine" id="cb13-7" title="7">receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="kw">n</span>())</a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">## # Source:   SQL [1 x 1]</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="co">##     `n()`</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="co">##   &lt;int64&gt;</span></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co">## 1  104681</span></a></code></pre></div>
<p>dbplyr 越しでは使えないメソッドもある. たとえば, <code>quantile</code> は <code>summarise</code> 以外では使えない.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"><span class="co"># cause error</span></a>
<a class="sourceLine" id="cb14-2" title="2">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">amount_quan1 =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile</span>(<span class="dt">probs =</span> <span class="fl">0.25</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">## Error: Failed to prepare query: ERROR:  OVER is not supported for ordered-set aggregate percentile_cont</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">## LINE 3:   PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY &quot;amount&quot;) OVE...</span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">##           ^</span></a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># quantile works under summarise method</span></a>
<a class="sourceLine" id="cb15-2" title="2">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount_quan1 =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile</span>(<span class="dt">probs =</span> <span class="fl">0.25</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="co">## # Source:   SQL [1 x 1]</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">##   amount_quan1</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co">##          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="co">## 1          102</span></a></code></pre></div>
</div>
<div id="データのダウンロード" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.5</span> データのダウンロード<a href="#データのダウンロード" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>実行結果を実データとして手元にダウンロードするには, <code>dplyr::collect()</code> を使うのが基本. これを実行した時点で DB との関連は切れて, ローカルの独立したデータとなる.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="st">    </span><span class="kw">count</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">    </span><span class="kw">collect</span>() <span class="co"># donwload data</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="co">## # A tibble: 1 × 1</span></a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co">##         n</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">##   &lt;int64&gt;</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">## 1  104681</span></a></code></pre></div>
<p>見慣れた <code>tibble</code> が落ちてきたことが確認できる.
ローカルに持ってくれば翻訳可能性問題は気にしなくてよくなる.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">q1 =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile</span>(<span class="dt">probs =</span> <span class="fl">0.25</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">## # A tibble: 6 × 10</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co">##   sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   </span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="co">##       &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         </span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">## 1  20181103  1541203200 S14006          112              1 CS006214000001</span></a>
<a class="sourceLine" id="cb17-9" title="9"><span class="co">## 2  20181118  1542499200 S13008         1132              2 CS008415000097</span></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co">## 3  20170712  1499817600 S14028         1102              1 CS028414000014</span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">## 4  20190205  1549324800 S14042         1132              1 ZZ000000000000</span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="co">## 5  20180821  1534809600 S14025         1102              2 CS025415000050</span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">## 6  20190605  1559692800 S13003         1112              1 CS003515000195</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">## # … with 4 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;, amount &lt;int&gt;,</span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co">## #   q1 &lt;dbl&gt;</span></a></code></pre></div>
<p><code>dplyr::pull(.data, var = -1, name = NULL,...)</code> では特定の列をベクトルデータとしてダウンロードできる. これはスカラー値を得たいときに特に便利.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">q1 =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">quantile</span>(<span class="dt">probs =</span> <span class="fl">0.25</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="st">    </span><span class="kw">pull</span>()</a>
<a class="sourceLine" id="cb18-4" title="4"><span class="co">## [1] 102</span></a></code></pre></div>
</div>
<div id="upload" class="section level2 hasAnchor">
<h2><span class="header-section-number">2.6</span> データのアップロード<a href="#upload" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><code>collect()</code> とは反対に, DB 側に新たなデータを作成する手段もある.
これには3つのシナリオが有り得る.</p>
<ul>
<li>ローカルデータを DB にテーブルとして書き込みたい場合</li>
<li>ローカルデータから <code>tbl_lazy</code> を作りたい場合</li>
<li><code>tbl_lazy</code> を DB にテーブルとして書き込みたい場合</li>
</ul>
<div id="ローカルデータ---db-テーブル" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.6.1</span> ローカルデータ -&gt; DB テーブル<a href="#ローカルデータ---db-テーブル" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>DBI::dbWriteTable()</code> または <code>DBI::dbCreateTable()</code> + <code>DBI::dbAppendTable()</code> を使うことを勧める.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co"># upload data by writing a table</span></a>
<a class="sourceLine" id="cb19-2" title="2">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">    </span>DBI<span class="op">::</span><span class="kw">dbWriteTable</span>(</a>
<a class="sourceLine" id="cb19-4" title="4">        <span class="co"># upload by writing</span></a>
<a class="sourceLine" id="cb19-5" title="5">        <span class="dt">name =</span> <span class="st">&quot;mtcars&quot;</span>,</a>
<a class="sourceLine" id="cb19-6" title="6">        <span class="dt">value =</span> mtcars,</a>
<a class="sourceLine" id="cb19-7" title="7">        <span class="dt">overwirte =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb19-8" title="8">    )</a>
<a class="sourceLine" id="cb19-9" title="9"></a>
<a class="sourceLine" id="cb19-10" title="10">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>() <span class="co"># show remote tables</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co">## [1] &quot;customer&quot; &quot;mtcars&quot;   &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a>
<a class="sourceLine" id="cb19-12" title="12">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="st">    </span><span class="kw">tbl</span>(<span class="st">&quot;mtcars&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb19-15" title="15"><span class="co">## # Source:   SQL [6 x 11]</span></a>
<a class="sourceLine" id="cb19-16" title="16"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb19-17" title="17"><span class="co">##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb19-18" title="18"><span class="co">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb19-19" title="19"><span class="co">## 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb19-20" title="20"><span class="co">## 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb19-21" title="21"><span class="co">## 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb19-22" title="22"><span class="co">## 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></a>
<a class="sourceLine" id="cb19-23" title="23"><span class="co">## 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2</span></a>
<a class="sourceLine" id="cb19-24" title="24"><span class="co">## 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1</span></a>
<a class="sourceLine" id="cb19-25" title="25"></a>
<a class="sourceLine" id="cb19-26" title="26"><span class="co"># by creating a table first and then append the data to it</span></a>
<a class="sourceLine" id="cb19-27" title="27"><span class="cf">if</span> (con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbExistsTable</span>(<span class="st">&quot;mtcars&quot;</span>)) {</a>
<a class="sourceLine" id="cb19-28" title="28">    con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbRemoveTable</span>(<span class="st">&quot;mtcars&quot;</span>)</a>
<a class="sourceLine" id="cb19-29" title="29">}</a>
<a class="sourceLine" id="cb19-30" title="30"></a>
<a class="sourceLine" id="cb19-31" title="31">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbCreateTable</span>(</a>
<a class="sourceLine" id="cb19-32" title="32">    <span class="dt">name =</span> <span class="st">&quot;mtcars&quot;</span>,</a>
<a class="sourceLine" id="cb19-33" title="33">    <span class="dt">fields =</span> mtcars</a>
<a class="sourceLine" id="cb19-34" title="34">)</a>
<a class="sourceLine" id="cb19-35" title="35"></a>
<a class="sourceLine" id="cb19-36" title="36">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbAppendTable</span>(</a>
<a class="sourceLine" id="cb19-37" title="37">    <span class="dt">name =</span> <span class="st">&quot;mtcars&quot;</span>,</a>
<a class="sourceLine" id="cb19-38" title="38">    <span class="dt">value =</span> mtcars</a>
<a class="sourceLine" id="cb19-39" title="39">)</a>
<a class="sourceLine" id="cb19-40" title="40"><span class="co">## [1] 32</span></a>
<a class="sourceLine" id="cb19-41" title="41">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>() <span class="co"># show remote tables</span></a>
<a class="sourceLine" id="cb19-42" title="42"><span class="co">## [1] &quot;customer&quot; &quot;mtcars&quot;   &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a>
<a class="sourceLine" id="cb19-43" title="43"><span class="kw">tbl</span>(con, <span class="st">&quot;mtcars&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb19-44" title="44"><span class="co">## # Source:   SQL [6 x 11]</span></a>
<a class="sourceLine" id="cb19-45" title="45"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb19-46" title="46"><span class="co">##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb19-47" title="47"><span class="co">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb19-48" title="48"><span class="co">## 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb19-49" title="49"><span class="co">## 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb19-50" title="50"><span class="co">## 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb19-51" title="51"><span class="co">## 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></a>
<a class="sourceLine" id="cb19-52" title="52"><span class="co">## 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2</span></a>
<a class="sourceLine" id="cb19-53" title="53"><span class="co">## 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1</span></a>
<a class="sourceLine" id="cb19-54" title="54">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbRemoveTable</span>(<span class="st">&quot;mtcars&quot;</span>)</a></code></pre></div>
<p>【余談】
<code>DBI::dbWriteTable()</code> は一度に色々なことができすぎてしまうという理由から, 相対的にインクリメンタルな <code>DBI::dbCreateTable()</code> と <code>DBI::dbAppendTable()</code> を組み合わせて使う方法を DBI は推奨しているらしい(?).</p>
</div>
<div id="ローカルデータ---tbl_lazy" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.6.2</span> ローカルデータ -&gt; tbl_lazy<a href="#ローカルデータ---tbl_lazy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>dbplyr::copy_inline()</code> を使う. これは現在のコネクションが切れれば消滅する一時的な <code>tbl_lazy</code> を作る.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">mtcars_tbl &lt;-<span class="st"> </span>con <span class="op">%&gt;%</span><span class="st"> </span>dbplyr<span class="op">::</span><span class="kw">copy_inline</span>(mtcars) <span class="co"># upload</span></a>
<a class="sourceLine" id="cb20-2" title="2">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">class</span>()</a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co">## [1] &quot;tbl_PqConnection&quot; &quot;tbl_sql&quot;          &quot;tbl_lazy&quot;         &quot;tbl&quot;</span></a>
<a class="sourceLine" id="cb20-4" title="4">con <span class="op">%&gt;%</span><span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbListTables</span>() <span class="co"># mtcars is not written in as a table</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">## [1] &quot;customer&quot; &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a>
<a class="sourceLine" id="cb20-6" title="6">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co">## # Source:   SQL [6 x 11]</span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co">##     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co">## 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">## 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="co">## 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb20-14" title="14"><span class="co">## 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></a>
<a class="sourceLine" id="cb20-15" title="15"><span class="co">## 5  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2</span></a>
<a class="sourceLine" id="cb20-16" title="16"><span class="co">## 6  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1</span></a></code></pre></div>
<p>当然ながら <code>copy_inline()</code> はどのテーブルも参照していない. 対応する SQL は元データの羅列からの SELECT 文となる.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">show_query</span>()</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">## &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co">## SELECT</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co">##   CAST(&quot;mpg&quot; AS NUMERIC) AS &quot;mpg&quot;,</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">##   CAST(&quot;cyl&quot; AS NUMERIC) AS &quot;cyl&quot;,</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">##   CAST(&quot;disp&quot; AS NUMERIC) AS &quot;disp&quot;,</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">##   CAST(&quot;hp&quot; AS NUMERIC) AS &quot;hp&quot;,</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">##   CAST(&quot;drat&quot; AS NUMERIC) AS &quot;drat&quot;,</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">##   CAST(&quot;wt&quot; AS NUMERIC) AS &quot;wt&quot;,</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="co">##   CAST(&quot;qsec&quot; AS NUMERIC) AS &quot;qsec&quot;,</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="co">##   CAST(&quot;vs&quot; AS NUMERIC) AS &quot;vs&quot;,</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">##   CAST(&quot;am&quot; AS NUMERIC) AS &quot;am&quot;,</span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="co">##   CAST(&quot;gear&quot; AS NUMERIC) AS &quot;gear&quot;,</span></a>
<a class="sourceLine" id="cb21-14" title="14"><span class="co">##   CAST(&quot;carb&quot; AS NUMERIC) AS &quot;carb&quot;</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co">## FROM (</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="co">##   VALUES</span></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="co">##     (21.0, 6.0, 160.0, 110.0, 3.9, 2.62, 16.46, 0.0, 1.0, 4.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-18" title="18"><span class="co">##     (21.0, 6.0, 160.0, 110.0, 3.9, 2.875, 17.02, 0.0, 1.0, 4.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="co">##     (22.8, 4.0, 108.0, 93.0, 3.85, 2.32, 18.61, 1.0, 1.0, 4.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-20" title="20"><span class="co">##     (21.4, 6.0, 258.0, 110.0, 3.08, 3.215, 19.44, 1.0, 0.0, 3.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-21" title="21"><span class="co">##     (18.7, 8.0, 360.0, 175.0, 3.15, 3.44, 17.02, 0.0, 0.0, 3.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-22" title="22"><span class="co">##     (18.1, 6.0, 225.0, 105.0, 2.76, 3.46, 20.22, 1.0, 0.0, 3.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-23" title="23"><span class="co">##     (14.3, 8.0, 360.0, 245.0, 3.21, 3.57, 15.84, 0.0, 0.0, 3.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-24" title="24"><span class="co">##     (24.4, 4.0, 146.7, 62.0, 3.69, 3.19, 20.0, 1.0, 0.0, 4.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-25" title="25"><span class="co">##     (22.8, 4.0, 140.8, 95.0, 3.92, 3.15, 22.9, 1.0, 0.0, 4.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-26" title="26"><span class="co">##     (19.2, 6.0, 167.6, 123.0, 3.92, 3.44, 18.3, 1.0, 0.0, 4.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-27" title="27"><span class="co">##     (17.8, 6.0, 167.6, 123.0, 3.92, 3.44, 18.9, 1.0, 0.0, 4.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-28" title="28"><span class="co">##     (16.4, 8.0, 275.8, 180.0, 3.07, 4.07, 17.4, 0.0, 0.0, 3.0, 3.0),</span></a>
<a class="sourceLine" id="cb21-29" title="29"><span class="co">##     (17.3, 8.0, 275.8, 180.0, 3.07, 3.73, 17.6, 0.0, 0.0, 3.0, 3.0),</span></a>
<a class="sourceLine" id="cb21-30" title="30"><span class="co">##     (15.2, 8.0, 275.8, 180.0, 3.07, 3.78, 18.0, 0.0, 0.0, 3.0, 3.0),</span></a>
<a class="sourceLine" id="cb21-31" title="31"><span class="co">##     (10.4, 8.0, 472.0, 205.0, 2.93, 5.25, 17.98, 0.0, 0.0, 3.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-32" title="32"><span class="co">##     (10.4, 8.0, 460.0, 215.0, 3.0, 5.424, 17.82, 0.0, 0.0, 3.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-33" title="33"><span class="co">##     (14.7, 8.0, 440.0, 230.0, 3.23, 5.345, 17.42, 0.0, 0.0, 3.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-34" title="34"><span class="co">##     (32.4, 4.0, 78.7, 66.0, 4.08, 2.2, 19.47, 1.0, 1.0, 4.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-35" title="35"><span class="co">##     (30.4, 4.0, 75.7, 52.0, 4.93, 1.615, 18.52, 1.0, 1.0, 4.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-36" title="36"><span class="co">##     (33.9, 4.0, 71.1, 65.0, 4.22, 1.835, 19.9, 1.0, 1.0, 4.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-37" title="37"><span class="co">##     (21.5, 4.0, 120.1, 97.0, 3.7, 2.465, 20.01, 1.0, 0.0, 3.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-38" title="38"><span class="co">##     (15.5, 8.0, 318.0, 150.0, 2.76, 3.52, 16.87, 0.0, 0.0, 3.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-39" title="39"><span class="co">##     (15.2, 8.0, 304.0, 150.0, 3.15, 3.435, 17.3, 0.0, 0.0, 3.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-40" title="40"><span class="co">##     (13.3, 8.0, 350.0, 245.0, 3.73, 3.84, 15.41, 0.0, 0.0, 3.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-41" title="41"><span class="co">##     (19.2, 8.0, 400.0, 175.0, 3.08, 3.845, 17.05, 0.0, 0.0, 3.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-42" title="42"><span class="co">##     (27.3, 4.0, 79.0, 66.0, 4.08, 1.935, 18.9, 1.0, 1.0, 4.0, 1.0),</span></a>
<a class="sourceLine" id="cb21-43" title="43"><span class="co">##     (26.0, 4.0, 120.3, 91.0, 4.43, 2.14, 16.7, 0.0, 1.0, 5.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-44" title="44"><span class="co">##     (30.4, 4.0, 95.1, 113.0, 3.77, 1.513, 16.9, 1.0, 1.0, 5.0, 2.0),</span></a>
<a class="sourceLine" id="cb21-45" title="45"><span class="co">##     (15.8, 8.0, 351.0, 264.0, 4.22, 3.17, 14.5, 0.0, 1.0, 5.0, 4.0),</span></a>
<a class="sourceLine" id="cb21-46" title="46"><span class="co">##     (19.7, 6.0, 145.0, 175.0, 3.62, 2.77, 15.5, 0.0, 1.0, 5.0, 6.0),</span></a>
<a class="sourceLine" id="cb21-47" title="47"><span class="co">##     (15.0, 8.0, 301.0, 335.0, 3.54, 3.57, 14.6, 0.0, 1.0, 5.0, 8.0),</span></a>
<a class="sourceLine" id="cb21-48" title="48"><span class="co">##     (21.4, 4.0, 121.0, 109.0, 4.11, 2.78, 18.6, 1.0, 1.0, 4.0, 2.0)</span></a>
<a class="sourceLine" id="cb21-49" title="49"><span class="co">## ) AS drvd(&quot;mpg&quot;, &quot;cyl&quot;, &quot;disp&quot;, &quot;hp&quot;, &quot;drat&quot;, &quot;wt&quot;, &quot;qsec&quot;, &quot;vs&quot;, &quot;am&quot;, &quot;gear&quot;, &quot;carb&quot;)</span></a></code></pre></div>
</div>
<div id="tbl_lazy---db-テーブル" class="section level3 hasAnchor">
<h3><span class="header-section-number">2.6.3</span> tbl_lazy -&gt; DB テーブル<a href="#tbl_lazy---db-テーブル" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>dplyr::copy_to()</code> を使う. デフォルトでは, 被る可能性のない変な名前の一時テーブルを作る. デフォルトのネーミングはあんまりなので(試してみるとよい), <code>name =</code> 引数で名前は指定した方がよい.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">    </span><span class="kw">tbl</span>(<span class="st">&quot;receipt&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="st">    </span><span class="kw">copy_to</span>(</a>
<a class="sourceLine" id="cb22-5" title="5">        <span class="dt">dest =</span> con,</a>
<a class="sourceLine" id="cb22-6" title="6">        <span class="dt">df =</span> .,</a>
<a class="sourceLine" id="cb22-7" title="7">        <span class="dt">name =</span> <span class="st">&quot;temp&quot;</span>,</a>
<a class="sourceLine" id="cb22-8" title="8">        <span class="dt">overwrite =</span> <span class="ot">TRUE</span> <span class="co"># optional</span></a>
<a class="sourceLine" id="cb22-9" title="9">    ) <span class="co"># from tbl_lazy to table</span></a>
<a class="sourceLine" id="cb22-10" title="10">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>()</a>
<a class="sourceLine" id="cb22-11" title="11"><span class="co">## [1] &quot;customer&quot; &quot;category&quot; &quot;temp&quot;     &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a>
<a class="sourceLine" id="cb22-12" title="12">con <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="st">    </span><span class="kw">tbl</span>(<span class="st">&quot;temp&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-14" title="14"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb22-15" title="15"><span class="co">## # Source:   SQL [6 x 9]</span></a>
<a class="sourceLine" id="cb22-16" title="16"><span class="co">## # Database: postgres  [guest@localhost:5432/knock100]</span></a>
<a class="sourceLine" id="cb22-17" title="17"><span class="co">##   sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   </span></a>
<a class="sourceLine" id="cb22-18" title="18"><span class="co">##       &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         </span></a>
<a class="sourceLine" id="cb22-19" title="19"><span class="co">## 1  20181225  1545696000 S13020         1172              2 ZZ000000000000</span></a>
<a class="sourceLine" id="cb22-20" title="20"><span class="co">## 2  20180911  1536624000 S13018         1122              2 CS018205000001</span></a>
<a class="sourceLine" id="cb22-21" title="21"><span class="co">## 3  20170501  1493596800 S13004         1192              2 CS004415000232</span></a>
<a class="sourceLine" id="cb22-22" title="22"><span class="co">## 4  20170523  1495497600 S14028         1182              2 CS028415000203</span></a>
<a class="sourceLine" id="cb22-23" title="23"><span class="co">## 5  20180310  1520640000 S14028          112              1 ZZ000000000000</span></a>
<a class="sourceLine" id="cb22-24" title="24"><span class="co">## 6  20170516  1494892800 S14023         1102              1 CS023415000240</span></a>
<a class="sourceLine" id="cb22-25" title="25"><span class="co">## # … with 3 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;, amount &lt;int&gt;</span></a>
<a class="sourceLine" id="cb22-26" title="26">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbDisconnect</span>()</a>
<a class="sourceLine" id="cb22-27" title="27">con &lt;-<span class="st"> </span><span class="kw">issue_con</span>() <span class="co"># user-defined function that issues a new connection variable</span></a>
<a class="sourceLine" id="cb22-28" title="28">con <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dbListTables</span>() <span class="co"># copied table disappeared</span></a>
<a class="sourceLine" id="cb22-29" title="29"><span class="co">## [1] &quot;customer&quot; &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</span></a></code></pre></div>
<p><code>dplyr::copy_to()</code> は, ローカルデータから一時テーブルを作成することもできる. その意味では, <code>DBI::dbWriteTable</code> などと似ている. しかし, 後者が一時テーブルを作る機能がサポートしているかどうかは, DBI のバックエンドパッケージ(e.g., RPostgres, RSQLite) に依存する. R の DB 通信における汎用インターフェースである DBI がサポートしていない機能を, dplyr で抜け道的に使うことは一般には避けるべきだろう. その意味で，<code>dplyr::copy_to()</code> はインプットを <code>tbl_lazy</code> に限定した使用方法に留めるべきではないかと思う.</p>

</div>
</div>
</div>
<div id="ref" class="section level1 hasAnchor">
<h1><span class="header-section-number">3</span> References: dbplyr, DBI, RPostgres 参考資料<a href="#ref" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<ul>
<li>Overview
<ul>
<li><a href="https://yutatoyama.github.io/note/intro_R_for_SQL.html">巨大なデータがSQLサーバーにあるときに、Rでどう立ち向かうかマニュアル：dbplyrパッケージを中心として</a></li>
<li><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a></li>
<li><a href="https://nuitrcs.github.io/databases_workshop/r/r_databases.html">R: Working with Databases</a></li>
<li><a href="https://dbi.r-dbi.org/articles/dbi">Introduction to DBI</a></li>
</ul></li>
<li>DBI
<ul>
<li><a href="http://delta0726.web.fc2.com/packages/database/00_RSQLite.html">RSQLite &amp; DBIの使い方</a></li>
<li><a href="https://dbi.r-dbi.org/articles/spec">DBI specification</a></li>
<li><a href="https://cran.r-project.org/web/packages/DBI/DBI.pdf">DBI: R Database Interface .pdf</a></li>
<li><a href="https://shena4746.github.io/code-examples-dbi-rpostgres/">Code Examples for DBI and RPostgres</a></li>
<li><a href="https://shena4746.github.io/r-functions-on-dbi/">User-defined functions that DBI + RPostgres users should have</a></li>
</ul></li>
<li>dbplyr 実践問題集
<ul>
<li><a href="https://shena4746.github.io/datascience-100knocks-preprocess-R/">dbplyrでデータサイエンス100本ノック</a></li>
</ul></li>
</ul>

</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "night",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "none",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

</body>

</html>
